// CommonJS version del worker per i 73 comuni della Provincia di Rieti
// Database completo dei comuni di Rieti

const comuniRietiDatabase = {
  'accumoli': {
    name: 'Accumoli',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.6947,
    longitude: 13.2442,
    population: 608,
    accuracy: 'high'
  },
  'amatrice': {
    name: 'Amatrice',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.6297,
    longitude: 13.2944,
    population: 2646,
    accuracy: 'high'
  },
  'antrodoco': {
    name: 'Antrodoco',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.4125,
    longitude: 13.0744,
    population: 2656,
    accuracy: 'high'
  },
  'ascrea': {
    name: 'Ascrea',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.2158,
    longitude: 12.9669,
    population: 233,
    accuracy: 'high'
  },
  'belmonte_in_sabina': {
    name: 'Belmonte in Sabina',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.2775,
    longitude: 12.8100,
    population: 729,
    accuracy: 'high'
  },
  'borbona': {
    name: 'Borbona',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.5186,
    longitude: 13.1322,
    population: 589,
    accuracy: 'high'
  },
  'borgo_velino': {
    name: 'Borgo Velino',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.3775,
    longitude: 13.0447,
    population: 1020,
    accuracy: 'high'
  },
  'borgorose': {
    name: 'Borgorose',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.1844,
    longitude: 13.2219,
    population: 4584,
    accuracy: 'high'
  },
  'cantalice': {
    name: 'Cantalice',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.4500,
    longitude: 12.9044,
    population: 2737,
    accuracy: 'high'
  },
  'cantalupo_in_sabina': {
    name: 'Cantalupo in Sabina',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.2644,
    longitude: 12.6669,
    population: 1668,
    accuracy: 'high'
  },
  'casaprota': {
    name: 'Casaprota',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.2361,
    longitude: 12.9719,
    population: 1587,
    accuracy: 'high'
  },
  'casperia': {
    name: 'Casperia',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.2719,
    longitude: 12.6594,
    population: 1283,
    accuracy: 'high'
  },
  'castel_sant_angelo': {
    name: 'Castel Sant\'Angelo',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.3644,
    longitude: 13.0450,
    population: 1434,
    accuracy: 'high'
  },
  'castel_di_tora': {
    name: 'Castel di Tora',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.2294,
    longitude: 12.9950,
    population: 317,
    accuracy: 'high'
  },
  'castelnuovo_di_farfa': {
    name: 'Castelnuovo di Farfa',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.2144,
    longitude: 12.7144,
    population: 1436,
    accuracy: 'high'
  },
  'cittaducale': {
    name: 'Cittaducale',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.3822,
    longitude: 12.9469,
    population: 6978,
    accuracy: 'high'
  },
  'cittareale': {
    name: 'Cittareale',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.6036,
    longitude: 13.1750,
    population: 436,
    accuracy: 'high'
  },
  'collalto_sabino': {
    name: 'Collalto Sabino',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.1675,
    longitude: 12.9425,
    population: 756,
    accuracy: 'high'
  },
  'colle_di_tora': {
    name: 'Colle di Tora',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.2425,
    longitude: 12.9819,
    population: 350,
    accuracy: 'high'
  },
  'collegiove': {
    name: 'Collegiove',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.2261,
    longitude: 13.0219,
    population: 232,
    accuracy: 'high'
  },
  'collevecchio': {
    name: 'Collevecchio',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.2594,
    longitude: 12.5950,
    population: 1455,
    accuracy: 'high'
  },
  'colli_sul_velino': {
    name: 'Colli sul Velino',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.3894,
    longitude: 12.9944,
    population: 458,
    accuracy: 'high'
  },
  'concerviano': {
    name: 'Concerviano',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.3044,
    longitude: 13.0169,
    population: 288,
    accuracy: 'high'
  },
  'configni': {
    name: 'Configni',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.2644,
    longitude: 12.8519,
    population: 492,
    accuracy: 'high'
  },
  'contigliano': {
    name: 'Contigliano',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.4019,
    longitude: 12.7975,
    population: 3669,
    accuracy: 'high'
  },
  'cottanello': {
    name: 'Cottanello',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.3194,
    longitude: 12.6900,
    population: 605,
    accuracy: 'high'
  },
  'fara_in_sabina': {
    name: 'Fara in Sabina',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.2181,
    longitude: 12.7211,
    population: 13816,
    accuracy: 'high'
  },
  'fiamignano': {
    name: 'Fiamignano',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.2381,
    longitude: 13.1644,
    population: 1436,
    accuracy: 'high'
  },
  'forano': {
    name: 'Forano',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.2619,
    longitude: 12.6044,
    population: 2952,
    accuracy: 'high'
  },
  'frasso_sabino': {
    name: 'Frasso Sabino',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.2175,
    longitude: 12.8769,
    population: 756,
    accuracy: 'high'
  },
  'greccio': {
    name: 'Greccio',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.4461,
    longitude: 12.7569,
    population: 1528,
    accuracy: 'high'
  },
  'labro': {
    name: 'Labro',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.5219,
    longitude: 12.8019,
    population: 374,
    accuracy: 'high'
  },
  'leonessa': {
    name: 'Leonessa',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.5669,
    longitude: 12.9625,
    population: 2621,
    accuracy: 'high'
  },
  'longone_sabino': {
    name: 'Longone Sabino',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.1744,
    longitude: 12.8744,
    population: 733,
    accuracy: 'high'
  },
  'magliano_sabina': {
    name: 'Magliano Sabina',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.2450,
    longitude: 12.4844,
    population: 3799,
    accuracy: 'high'
  },
  'marcetelli': {
    name: 'Marcetelli',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.2144,
    longitude: 13.0444,
    population: 98,
    accuracy: 'high'
  },
  'micigliano': {
    name: 'Micigliano',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.4569,
    longitude: 13.0319,
    population: 363,
    accuracy: 'high'
  },
  'mompeo': {
    name: 'Mompeo',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.1944,
    longitude: 12.9044,
    population: 285,
    accuracy: 'high'
  },
  'montasola': {
    name: 'Montasola',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.2244,
    longitude: 12.8244,
    population: 564,
    accuracy: 'high'
  },
  'monte_san_giovanni_in_sabina': {
    name: 'Monte San Giovanni in Sabina',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.2319,
    longitude: 12.7819,
    population: 580,
    accuracy: 'high'
  },
  'montebuono': {
    name: 'Montebuono',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.2319,
    longitude: 12.6144,
    population: 871,
    accuracy: 'high'
  },
  'monteleone_sabino': {
    name: 'Monteleone Sabino',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.1619,
    longitude: 12.8419,
    population: 1649,
    accuracy: 'high'
  },
  'montenero_sabino': {
    name: 'Montenero Sabino',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.1819,
    longitude: 12.7819,
    population: 519,
    accuracy: 'high'
  },
  'montopoli_di_sabina': {
    name: 'Montopoli di Sabina',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.1819,
    longitude: 12.6244,
    population: 4243,
    accuracy: 'high'
  },
  'morro_reatino': {
    name: 'Morro Reatino',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.4744,
    longitude: 12.8294,
    population: 660,
    accuracy: 'high'
  },
  'nespolo': {
    name: 'Nespolo',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.1944,
    longitude: 13.0644,
    population: 297,
    accuracy: 'high'
  },
  'orvinio': {
    name: 'Orvinio',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.2244,
    longitude: 12.8744,
    population: 421,
    accuracy: 'high'
  },
  'paganico_sabino': {
    name: 'Paganico Sabino',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.2044,
    longitude: 12.7244,
    population: 895,
    accuracy: 'high'
  },
  'pescorocchiano': {
    name: 'Pescorocchiano',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.1544,
    longitude: 13.1144,
    population: 2252,
    accuracy: 'high'
  },
  'petrella_salto': {
    name: 'Petrella Salto',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.2044,
    longitude: 13.0244,
    population: 1267,
    accuracy: 'high'
  },
  'poggio_bustone': {
    name: 'Poggio Bustone',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.4944,
    longitude: 12.8444,
    population: 2178,
    accuracy: 'high'
  },
  'poggio_catino': {
    name: 'Poggio Catino',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.2644,
    longitude: 12.6244,
    population: 1300,
    accuracy: 'high'
  },
  'poggio_mirteto': {
    name: 'Poggio Mirteto',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.2719,
    longitude: 12.6844,
    population: 6570,
    accuracy: 'high'
  },
  'poggio_moiano': {
    name: 'Poggio Moiano',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.2319,
    longitude: 12.8644,
    population: 2805,
    accuracy: 'high'
  },
  'poggio_nativo': {
    name: 'Poggio Nativo',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.2144,
    longitude: 12.6744,
    population: 1777,
    accuracy: 'high'
  },
  'poggio_san_lorenzo': {
    name: 'Poggio San Lorenzo',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.2144,
    longitude: 12.8344,
    population: 1113,
    accuracy: 'high'
  },
  'posta': {
    name: 'Posta',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.5544,
    longitude: 13.0644,
    population: 791,
    accuracy: 'high'
  },
  'pozzaglia_sabina': {
    name: 'Pozzaglia Sabina',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.1844,
    longitude: 12.8044,
    population: 321,
    accuracy: 'high'
  },
  'rieti': {
    name: 'Rieti',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.4040,
    longitude: 12.8628,
    population: 47700,
    accuracy: 'high'
  },
  'rivodutri': {
    name: 'Rivodutri',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.3644,
    longitude: 12.8244,
    population: 1353,
    accuracy: 'high'
  },
  'rocca_sinibalda': {
    name: 'Rocca Sinibalda',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.2244,
    longitude: 12.9244,
    population: 851,
    accuracy: 'high'
  },
  'roccantica': {
    name: 'Roccantica',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.2819,
    longitude: 12.6444,
    population: 990,
    accuracy: 'high'
  },
  'salisano': {
    name: 'Salisano',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.2744,
    longitude: 12.7244,
    population: 800,
    accuracy: 'high'
  },
  'scandriglia': {
    name: 'Scandriglia',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.1944,
    longitude: 12.7944,
    population: 2144,
    accuracy: 'high'
  },
  'selci': {
    name: 'Selci',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.3144,
    longitude: 12.6044,
    population: 1159,
    accuracy: 'high'
  },
  'stimigliano': {
    name: 'Stimigliano',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.2744,
    longitude: 12.5744,
    population: 2576,
    accuracy: 'high'
  },
  'tarano': {
    name: 'Tarano',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.2244,
    longitude: 12.5544,
    population: 1765,
    accuracy: 'high'
  },
  'toffia': {
    name: 'Toffia',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.2319,
    longitude: 12.7119,
    population: 1108,
    accuracy: 'high'
  },
  'torri_in_sabina': {
    name: 'Torri in Sabina',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.2319,
    longitude: 12.7644,
    population: 1308,
    accuracy: 'high'
  },
  'torricella_in_sabina': {
    name: 'Torricella in Sabina',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.2144,
    longitude: 12.7444,
    population: 1323,
    accuracy: 'high'
  },
  'turania': {
    name: 'Turania',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.2044,
    longitude: 13.0844,
    population: 371,
    accuracy: 'high'
  },
  'vacone': {
    name: 'Vacone',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.2544,
    longitude: 12.5844,
    population: 192,
    accuracy: 'high'
  },
  'varco_sabino': {
    name: 'Varco Sabino',
    province: 'Rieti',
    region: 'Lazio',
    latitude: 42.2244,
    longitude: 13.0444,
    population: 206,
    accuracy: 'high'
  }
};

// Funzione per normalizzare i nomi dei comuni
const normalizeNome = (nome) => {
  return nome.toLowerCase()
    .replace(/[\s\-']/g, '_')
    .replace(/[àáâã]/g, 'a')
    .replace(/[èéêë]/g, 'e')
    .replace(/[ìíîï]/g, 'i')
    .replace(/[òóôõ]/g, 'o')
    .replace(/[ùúûü]/g, 'u');
};

// Funzione di ricerca città
const searchCities = (query) => {
  const normalizedQuery = normalizeNome(query);
  const results = [];

  if (comuniRietiDatabase[normalizedQuery]) {
    results.push(comuniRietiDatabase[normalizedQuery]);
  } else {
    Object.entries(comuniRietiDatabase).forEach(([key, city]) => {
      const normalizedCityName = normalizeNome(city.name);
      
      if (normalizedCityName === normalizedQuery) {
        results.push(city);
      }
      else if (normalizedCityName.includes(normalizedQuery) || normalizedQuery.includes(normalizedCityName)) {
        results.push(city);
      }
      else if (normalizedQuery.includes('_') || normalizedCityName.includes('_')) {
        const queryParts = normalizedQuery.split('_').filter(part => part.length > 2);
        const cityParts = normalizedCityName.split('_').filter(part => part.length > 2);
        
        if (queryParts.some(qPart => cityParts.some(cPart => 
          cPart === qPart || cPart.startsWith(qPart) || 
          (qPart.length > 3 && cPart.startsWith(qPart.substring(0, Math.max(3, qPart.length - 1))))
        ))) {
          results.push(city);
        }
      }
    });
  }

  const uniqueResults = Array.from(new Set(results.map(r => r.name)))
    .map(name => results.find(r => r.name === name))
    .sort((a, b) => (b.population || 0) - (a.population || 0));

  return uniqueResults;
};

// Funzione per reverse geocoding
const reverseGeocode = (lat, lng, radius = 0.1) => {
  const results = [];
  
  Object.values(comuniRietiDatabase).forEach(city => {
    const distance = Math.sqrt(
      Math.pow(lat - city.latitude, 2) + 
      Math.pow(lng - city.longitude, 2)
    );
    
    if (distance <= radius) {
      results.push({
        ...city,
        distance: distance
      });
    }
  });
  
  return results.sort((a, b) => a.distance - b.distance);
};

const workerHandler = {
  async fetch(request, env) {
    const url = new URL(request.url);
    
    // Configurazione API Key per test
    const VALID_API_KEY = env?.API_KEY || 'rieti-api-2024-secure-key-73-comuni';
    
    // Funzione per validare API key
    const validateApiKey = () => {
      const apiKey = request.headers.get('X-API-Key') || request.headers.get('x-api-key');
      return apiKey === VALID_API_KEY;
    };
    
    const headers = {
      'Content-Type': 'application/json; charset=utf-8',
      'Access-Control-Allow-Origin': '*',
      'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
      'Access-Control-Allow-Headers': 'Content-Type, X-API-Key',
      'Cache-Control': 'public, max-age=3600'
    };

    if (request.method === 'OPTIONS') {
      return new Response(null, { status: 200, headers });
    }

    try {
      // Controllo API Key per tutte le route (eccetto la route informazioni)
      if (url.pathname !== '/api' && url.pathname !== '/api/' && !validateApiKey()) {
        return new Response(JSON.stringify({
          error: 'Unauthorized',
          message: 'Missing or invalid API key. Please provide a valid X-API-Key header.',
          statusCode: 401,
          success: false
        }), { 
          status: 401, 
          headers: {
            ...headers,
            'WWW-Authenticate': 'ApiKey realm="API Coordinate Rieti"'
          }
        });
      }
      if (url.pathname === '/api' || url.pathname === '/api/') {
        return new Response(JSON.stringify({
          name: "API Coordinate Comuni Provincia di Rieti",
          totalCities: Object.keys(comuniRietiDatabase).length,
          supportedCities: Object.keys(comuniRietiDatabase),
          authentication: {
            type: "API Key",
            header: "X-API-Key",
            required: "All endpoints except /api/ require valid API key"
          },
          success: true
        }), { status: 200, headers });
      }

      if (url.pathname === '/api/coordinates/search') {
        const query = url.searchParams.get('q');
        
        if (!query || query.trim().length < 1) {
          return new Response(JSON.stringify({
            error: "Missing required parameter 'q' (query)",
            success: false
          }), { status: 400, headers });
        }

        const results = searchCities(query.trim());
        
        if (results.length === 0) {
          return new Response(JSON.stringify({
            results: [],
            message: "No cities found matching your query in Provincia di Rieti",
            success: false
          }), { status: 404, headers });
        }

        return new Response(JSON.stringify({
          results: results,
          success: true
        }), { status: 200, headers });
      }

      if (url.pathname.startsWith('/api/coordinates/') && !url.pathname.includes('/search') && !url.pathname.includes('/reverse')) {
        const cityName = url.pathname.split('/api/coordinates/')[1];
        const normalizedCity = normalizeNome(cityName);
        const city = comuniRietiDatabase[normalizedCity];

        if (!city) {
          return new Response(JSON.stringify({
            error: "City not found",
            availableCities: Object.keys(comuniRietiDatabase).slice(0, 10),
            success: false
          }), { status: 404, headers });
        }

        return new Response(JSON.stringify({
          result: city,
          success: true
        }), { status: 200, headers });
      }

      if (url.pathname === '/api/coordinates/reverse') {
        const lat = parseFloat(url.searchParams.get('lat'));
        const lng = parseFloat(url.searchParams.get('lng'));

        if (isNaN(lat) || isNaN(lng)) {
          return new Response(JSON.stringify({
            error: "Invalid coordinates",
            success: false
          }), { status: 400, headers });
        }

        const results = reverseGeocode(lat, lng);
        
        return new Response(JSON.stringify({
          results: results,
          success: true
        }), { status: 200, headers });
      }

      return new Response(JSON.stringify({
        error: "Endpoint not found",
        success: false
      }), { status: 404, headers });

    } catch (error) {
      return new Response(JSON.stringify({
        error: "Internal server error",
        success: false
      }), { status: 500, headers });
    }
  }
};

module.exports = { workerHandler, comuniRietiDatabase };